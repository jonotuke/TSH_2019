---
title: "Modelling"
author: "Jono Tuke"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: spacelab
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%",
  fig.align = "center", 
  root.dir = '../'
)
pacman::p_load(
  tidyverse, lubridate, stringr, glue, lme4, lmerTest, 
  multcomp
)
source("../code/get_label.R")
source("../code/visualise_ci.R")
source("../code/get_cov.R")
```

# Read in clean data

```{r}
# TSH_long  <- read_rds("../data/20190716-02_convert_long.rds")
# TSH_long  <- read_rds("../data/2019082-02_convert_long.rds")
TSH_long  <- read_rds("../data/20190716-02_convert_long.rds")
```


# Modelling

## Three thyroid tests

We will use a mixed-effect model with the paper ID as a random intercept and thyroid method as a fixed effect. 

Need to convert `Sig` to factor. Also remove missing

```{r}
TSH_long  <- 
  TSH_long %>% 
  mutate(Sig = factor(Sig))
```

```{r}
TSH_long <- 
  TSH_long %>% filter(!is.na(Sig))
```

Convert Thyroid test to factor

```{r}
TSH_long  <- 
  TSH_long %>% 
  mutate(
    Thyroid_test = factor(Thyroid_test)
  )
```


Load necessary packages

```{r}
pacman::p_load(lme4, lmerTest)
```

### Random effects

Start with single fixed effect - thyroid test, and single random intercept (RI) for each paper. 

```{r}
tsh_glmer  <- glmer(Sig ~ Thyroid_test + (1 | Paper), data = TSH_long, family = binomial)
```

Compare model to one without RI.

```{r}
tsh_glm  <- glm(Sig ~ Thyroid_test, data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glm)
```

Looks like need RI. 

### Fixed effects

Test for significant differences between tests. 

```{r}
tsh_glmer_null  <- glmer(Sig ~ 1 + (1 | Paper), data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glmer_null)
```

Looks like significant effect of test. 

Also check with BIC - smaller is better. 

```{r}
BIC(tsh_glmer_null, tsh_glm, tsh_glmer)
```

So far best model is fixed effect of test with RI. 

```{r}
summary(tsh_glmer)
```

From this - look at fixed effect output. We have that TSH has a signicantly smaller probability of significance compared to T4. T3 and T4 are not significantly different. 

### Pairwise comparisons

```{r}
summary(glht(tsh_glmer, linfct = mcp(Thyroid_test = "Tukey")))
```

So significant difference between

- TSH and Free T4, and 
- TSH and T3.


### Notes

So we seem to have a lot of problems getting the RI to fit. May be able to tinker and improve. Looking at the various possible covariates we find that some of them increase the prediction of the probability of significance - system and number of subject. This is based on BIC. Number of covariates does not seem to improve the model. 

## Four thyroid tests

Will remove single T3

```{r}
TSH_long %>% count(Thyroid_test_4)
```

### Random effects

```{r}
tsh_glmer  <- glmer(Sig ~ Thyroid_test_4 + (1 | Paper), 
                    data = TSH_long, family = binomial)
tsh_glm  <- glm(Sig ~ Thyroid_test_4, 
                data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glm)
```

So we need a random intercept. 

### Fixed effects

```{r}
tsh_glmer_null  <- glmer(Sig ~ 1 + (1 | Paper), 
                         data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glmer_null)
```

So the treatments are significant. 

```{r}
summary(tsh_glmer)
```

### Pairwise comparisons

```{r}
summary(glht(tsh_glmer, linfct = mcp(Thyroid_test_4 = "Tukey")))
```

So significant difference between

- TSH and Free T4, 
- TSH and Free T3, and 
- TSH and Total T3. 

## Try adding in other covariates. 

For these, we keep thyroid test and try adding in the given covariate, also try upto two-way interaction. 

### System

```{r, cache=TRUE}
system_models  <- get_cov("system")
system_models %>% arrange(BIC) %>% knitr::kable()
```

Best model (BIC) is thyroid test + random intercept. 


### N of subjects

```{r, cache=TRUE}
N_models  <- get_cov("N_bin")
N_models %>% arrange(BIC) %>% knitr::kable()
```

Best model (BIC) is thyroid test + random intercept. 

### Number of covariates

```{r, cache=TRUE}
n_cov_models  <- get_cov("n_cov")
n_cov_models %>% arrange(BIC) %>% knitr::kable()
```

Best model (BIC) is thyroid test + random intercept. 


# Model to take into account cohorts

## Background

We have added a cohort based on sample size within paper

```{r}
TSH_long %>% 
  dplyr::select(
  Paper, N, cohort
)
```

So we have cohort nested within paper. 

Looked at the lme4 paper

```{r, echo = FALSE}
knitr::include_graphics("../figs/20190601-lme4-paper.png")
```

The notation is given in Table 2 of the paper:

```{r, echo = FALSE}
knitr::include_graphics("../figs/20190601-nest-RE.png")
```


Looks like we want

```
(1 | paper/cohort)
```

## Fit models

```{r}
tsh_glmer_M_paperRI  <- glmer(Sig ~ Thyroid_test + (1 | Paper), 
                              data = TSH_long, family = binomial)
tsh_glmer_M_paper_cohort_RI  <- glmer(Sig ~ Thyroid_test + (1 | Paper / cohort), 
                                      data = TSH_long, family = binomial)
tsh_glmer_M_no_test  <- glmer(Sig ~ 1 + (1 | Paper / cohort), 
                              data = TSH_long, family = binomial)
```

## Random terms

First test for whether need cohort RI:

```{r}
anova(tsh_glmer_M_paperRI, tsh_glmer_M_paper_cohort_RI)
```

Small p-value so looks like we need cohort and paper RI. 

## Fixed effects

Now test for significant effect of test

```{r}
anova(tsh_glmer_M_paper_cohort_RI, tsh_glmer_M_no_test)
```

So still significant effect of type of test. 

## Final model
Look at effect of test. 

```{r}
summary(tsh_glmer_M_paper_cohort_RI)
```

As before probability of significance is significantly lower than FT4 and T3. 

## Pairwise comparisons

```{r}
summary(glht(tsh_glmer_M_paper_cohort_RI, linfct = mcp(Thyroid_test = "Tukey")))
```

## Assumptions

```{r}
plot(tsh_glmer_M_paper_cohort_RI)
```

# Model to take into account style

Will be similar to above. First examine possible styles

```{r}
TSH_long %>% 
  count(CvQ) %>% 
  knitr::kable()
```


Need to talk to NB about which to keep. 

Decided that only keep those with number of obs greater than 10. 

```{r}
TSH_long <- 
  TSH_long %>% 
  mutate(
    style = fct_lump_min(CvQ, min = 10)
  )
TSH_long %>% 
  count(CvQ, style) %>% 
  knitr::kable()
```


## Fit all models

```{r}
tsh_glmer_M_paperRI  <- glmer(Sig ~ Thyroid_test + (1 | Paper), 
                              data = TSH_long, family = binomial)
tsh_glmer_M_paper_style_RI  <- glmer(Sig ~ Thyroid_test + (1 | Paper / style), 
                                      data = TSH_long, family = binomial)
tsh_glmer_M_no_test  <- glmer(Sig ~ 1 + (1 | Paper / style), 
                              data = TSH_long, family = binomial)
```

## Random terms

```{r}
anova(tsh_glmer_M_paperRI, tsh_glmer_M_paper_style_RI)
```

No significant effect of style. 

# Model to take into account sophistication

## Check and clean

```{r}
TSH_long %>% 
  count(Sophistication)
```

Need to remove NAs

```{r}
TSH_long_noNA  <- 
  TSH_long %>% 
  filter(!is.na(Sophistication))
```


Fit all models

```{r}
tsh_glmer_M_paperRI  <- glmer(Sig ~ Thyroid_test + (1 | Paper), 
                              data = TSH_long_noNA, family = binomial)
tsh_glmer_M_paper_soph_RI  <- glmer(Sig ~ Thyroid_test + (1 | Paper / Sophistication), 
                                      data = TSH_long_noNA, family = binomial)
tsh_glmer_M_no_test  <- glmer(Sig ~ 1 + (1 | Paper / cohort), 
                              data = TSH_long_noNA, family = binomial)
```

## Random effects

First test for whether need sophistication RI:

```{r}
anova(tsh_glmer_M_paperRI, tsh_glmer_M_paper_soph_RI)
```

Not significant so not needed. 

# Look at selected systems

```{r}
high_low_models  <- get_cov("high_low")
high_low_models %>% arrange(BIC) %>% knitr::kable()
```

To little data to fit. 

# Apply Devil's Advocate

## Low models

```{r}
TSH_long_low  <- 
  TSH_long %>% 
  filter(low_selected == TRUE)
```

### Fit models

```{r}
M1  <- glmer(Sig ~ Thyroid_test + (1 | Paper), 
             data = TSH_long_low, family = binomial)
M2  <- glm(Sig ~ Thyroid_test, 
             data = TSH_long_low, family = binomial)
M3  <- glm(Sig ~ 1, 
             data = TSH_long_low, family = binomial)
```

### Check RI

```{r}
anova(M1, M2)
```

Random intercept not needed. 

### Thyroid test

```{r}
anova(M2, M3, test = "LRT")
```

Still significant effect of test

### Final model

```{r}
summary(M2)
summary(glht(M2, linfct = mcp(Thyroid_test = "Tukey")))
```

So significant difference between TSH and Free T4

## High models

```{r}
TSH_long_high  <- 
  TSH_long %>% 
  filter(high_selected == TRUE)
```

### Fit models

```{r}
M1  <- glmer(Sig ~ Thyroid_test + (1 | Paper), 
             data = TSH_long_high, family = binomial)
M2  <- glm(Sig ~ Thyroid_test, 
             data = TSH_long_high, family = binomial)
M3  <- glm(Sig ~ 1, 
             data = TSH_long_high, family = binomial)
```

### Check RI

```{r}
anova(M1, M2)
```

Random intercept needed. 

### Thyroid test

```{r}
anova(M1, M3)
```

Still significant effect of test

### Final model

```{r}
summary(M1)
summary(glht(M1, linfct = mcp(Thyroid_test = "Tukey")))
```

So significant difference between 

- T3 and Free T4, and 
- TSH and Free T4. 


