---
title: "Convert to long form"
author: "Jono Tuke"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: spacelab
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%",
  fig.align = "center", 
  root.dir = '../'
)
pacman::p_load(
  tidyverse, lubridate, stringr, glue
)
source("../code/get_label.R")
```

# Read in clean data

```{r}
TSH  <- read_rds("../data/2019082-01_cleaning-data.rds")
TSH
```

# Remove grouping

```{r}
TSH  <- TSH %>% ungroup()
```

# Add ID

```{r}
TSH$ID  <- seq_along(TSH$Paper)
```

# Convert to long form

First take the the significance so row for each significance result. The key measure is made up of two parts - thanks NB for listening - this means that we can split into measure and T4 form

```{r}
TSH_long  <- 
  TSH  %>% 
  gather(key = "key", value = "value", dplyr::matches("FT4|TSH|T3") ) %>% 
  separate(key, into = c("Thyroid_test", "measure")) %>% 
  spread(measure, value)
# spec  <- TSH %>%
#   pivot_longer_spec(
#     cols = dplyr::matches("FT4|TSH|T3"),
#     names_to = c("Thyroid_test", ".value"),
#     names_sep = "_" )
# spec
# TSH_long  <-
#   TSH %>% 
#   ungroup() %>% 
#   pivot_longer(spec = spec)
# TSH_long
```

# Add in extra treatment

So we will split T3 into T3_total and T3_free

```{r}
TSH_long <- 
  TSH_long %>% 
  mutate(
    Thyroid_test_4 = ifelse(
      is.na(total), 
      Thyroid_test, 
      paste0(Thyroid_test, "_",total)
    )
  )
TSH_long %>% 
  count(Thyroid_test_4)
```

# Add in high low classification of systems

Based on classification by SF. 

```{r}
TSH_long <- 
  TSH_long %>% 
  mutate(high_low = case_when(
    str_detect(Condition, "AF") ~ "high", 
    str_detect(Condition, "low bone density") ~ "high", 
    system == "cancer" ~ "high", 
    str_detect(Condition, "fatty liver") ~ "low", 
    system == "metabolic" ~ "low", 
    TRUE ~ "both"
  ))
```


# Number of covariates in the model

```{r}
TSH_long$n_cov  <- str_split(TSH_long$cov, ",") %>% map(length) %>% unlist()
table(TSH_long$n_cov)
```

Will split into 1, 2, 3, more

```{r}
TSH_long <- 
  TSH_long %>% 
  mutate(
    n_cov = case_when(
      n_cov == 1 ~ "1", 
      n_cov == 2 ~ "2", 
      n_cov == 3 ~ "3", 
      TRUE ~ "more"
    )
  )
```

# N

```{r}
TSH_long$N  <- as.numeric(TSH_long$N)
TSH_long
TSH_long %>% ggplot(aes(N)) + geom_histogram(col = "black", fill = "orange")
summary(TSH_long$N)
TSH_long  <- 
  TSH_long %>% 
  mutate(N_bin = cut_number(N, 5))
TSH_long %>% filter(is.na(N_bin))
```

```{r}
TSH_long
```




# Write data

```{r}
write_rds(TSH_long, glue("../data/{get_label()}"))
```

