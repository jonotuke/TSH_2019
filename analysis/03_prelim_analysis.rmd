---
title: "Prelim analysis"
author: "Jono Tuke"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: spacelab
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%",
  fig.align = "center", 
  root.dir = '../'
)
pacman::p_load(
  tidyverse, lubridate, stringr, glue, lme4, lmerTest
)
source("../code/get_label.R")
source("../code/visualise_ci.R")
source("../code/get_cov.R")
```

# Read in clean data

```{r}
TSH_long  <- read_rds("../data/20190530-02_convert_long.rds")
TSH_long
```


# Visual comparison

## Overall

```{r}
overall_ci  <- 
  TSH_long %>% 
  filter(!is.na(Sig)) %>% 
  group_by(Thyroid_test) %>% 
  summarise(
    n_sig = sum(Sig == "Y"), 
    N = n(), 
    p = n_sig / N,
    lwr = p - 1.96 * sqrt(p * (1 - p) / N),
    upr = p + 1.96 * sqrt(p * (1 - p) / N)
  )
overall_ci
ggplot(overall_ci, aes( Thyroid_test, p, col = Thyroid_test)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.1) + 
  theme(legend.position = "none") + 
  labs(y = "Proportion")
```


## System

```{r}
visualise_ci(TSH_long, system)
```

## Method

```{r, fig.asp=1}
visualise_ci(TSH_long, method)
```

Too many to see a good pattern. 

## N

```{r}
TSH_long %>% ggplot(aes(N)) + geom_histogram(col = "black", fill = "orange")
TSH_long  <- 
  TSH_long %>% 
  mutate(N_bin = cut_number(N, 5))
TSH_long %>% filter(is.na(N_bin))
visualise_ci(TSH_long, N_bin)
```

Looks like some interaction effect


## Number of covariates in model

```{r}
TSH_long$n_cov  <- str_split(TSH_long$cov, ",") %>% map(length) %>% unlist()
table(TSH_long$n_cov)
```

Will split into 1, 2, 3, more

```{r}
TSH_long <- 
  TSH_long %>% 
  mutate(
    n_cov = case_when(
      n_cov == 1 ~ "1", 
      n_cov == 2 ~ "2", 
      n_cov == 3 ~ "3", 
      TRUE ~ "more"
    )
  )
```

```{r}
visualise_ci(TSH_long, n_cov)
```

Again some interaction. 

# Modelling

We will use a mixed-effect model with the paper ID as a random intercept and thyroid method as a fixed effect. 

Need to convert `Sig` to factor

```{r}
TSH_long  <- 
  TSH_long %>% 
  mutate(Sig = factor(Sig))
```


Load necessary packages

```{r}
pacman::p_load(lme4, lmerTest)
```

Start with single fixed effect - thyroid test, and single random intercept (RI) for each paper. 

```{r}
tsh_glmer  <- glmer(Sig ~ Thyroid_test + (1 | ID), data = TSH_long, family = binomial)
```

Compare model to one without RI.

```{r}
tsh_glm  <- glm(Sig ~ Thyroid_test, data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glm)
```

Looks like need RI. 

Test for significant differences between tests. 

```{r}
tsh_glmer_null  <- glmer(Sig ~ 1 + (1 | ID), data = TSH_long, family = binomial)
anova(tsh_glmer, tsh_glmer_null)
```

Looks like significant effect of test. 


Also check with BIC - smaller is better. 

```{r}
BIC(tsh_glmer_null, tsh_glm, tsh_glmer)
```

So far best model is fixed effect of test with RI. 

```{r}
summary(tsh_glmer)
```

From this - look at fixed effect output. We have that TSH has a signicantly smaller probability of significance compared to T4. T3 and T4 are not significantly different. 

## Try adding in other covariates. 

### System

```{r, cache=TRUE}
system_models  <- get_cov("system")
system_models %>% arrange(BIC) %>% knitr::kable()
```

### N of subjects

```{r, cache=TRUE}
N_models  <- get_cov("N_bin")
N_models %>% arrange(BIC) %>% knitr::kable()
```

### Number of covariates

```{r, cache=TRUE}
n_cov_models  <- get_cov("n_cov")
n_cov_models %>% arrange(BIC) %>% knitr::kable()
```


So we seem to have a lot of problems getting the RI to fit. May be able to tinker and improve. Looking at the various possible covariates we find that some of them increase the prediction of the probability of significance - system and number of subject. This is based on BIC. Number of covariates does not seem to improve the model. 

