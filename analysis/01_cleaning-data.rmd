---
title: "Cleaning of the data"
author: "Jono Tuke"
date: "21/03/2019"
output: 
  html_document:
    theme: spacelab
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.width = 6, 
  fig.asp = 0.618, 
  out.width = "70%",
  fig.align = "center", 
  root.dir = '../'
)
pacman::p_load(tidyverse, readxl, 
               tidytext, refinr, 
               lubridate, glue, 
               stringr, knitr, testthat)
source("../code/get_label.R")
source("../code/clean_levels.R")
source("../code/clean_n.R")
source("../code/get_inferred.R")
source("../code/clean_pv.R")
source("../code/add_cohort.R")
source("../code/get_DA.R")
```

# Nigel's cleaning

Nigel did some cleaning of the original dataset as follows

## 18th March 2019

- Copy Paper ID to all rows involving that paper.
- Copy Condition to all relevant rows. 
- Create a new column containing "Continuous", "Quartile" etc.
- Delete blank rows within a paper, currently left blank rows separating papers to make it easier to read
- Highlighted any obviously dubious cells/entries in Red, left yellow ones from Stephen for clarification
- Tidied up "minus" entries - Note that the Confidence Interval notation is not standardised! 
- Explicitly annotated "plus" with the prior categories
- Removed "adj" from conditions, where the covariates indicate a deeper analysis
- Inserted annotations, such as "- male", into the "Condition" description to uniquely identify each test. 

# Read in the data

```{r}
# TSH  <- read_excel("../data/20190318_excel tsh_2019_data.xlsx")
# TSH  <- read_excel("../raw data/20190519_excel tsh_2019_data.xlsx")
# TSH  <- read_excel("../raw data/20190708_excel tsh_2019_data.xlsx")
TSH  <- read_excel("../raw data/20190714_excel tsh2_2019_data.xlsx")
TSH
```

# Cleaning of the data

## Missing rows

Nigel has mentioned that left blank rows between the papers, we will remove these

```{r}
TSH  <- 
  TSH %>% 
  filter(!is.na(Paper))
TSH
```

So drop from 509 rows to 460. 

## Add an ID

```{r}
TSH$ID  <- seq_along(TSH$Paper)
```

## Paper

```{r, fig.asp = 1.5}
TSH %>% 
  count(Paper) %>% 
  ggplot(aes(fct_reorder(Paper, n), n)) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  labs(x = NULL, y = "Number of results")
```

Not sure about Chaker and Chaker *

Turns out that Chaker * was Chaker _et al._. All fixed by NB. 

## Continuous versus quantile

First rename to make easier

```{r}
TSH  <- 
  TSH %>% 
  rename(CvQ = `Continuous V quantile`)
```

```{r}
TSH %>% 
  count(CvQ)
```

I assume that `quartile analysis` and `Quartile analysis` are the same so collapse, similar process for others. This has been fixed by NB in raw data file. 

Will map `dichotomised` to `Dichotomous`

```{r}
TSH  <- 
  TSH %>% 
  mutate(
    CvQ = str_replace(CvQ, "dichotomised", "Dichotomous")
    )
```

```{r}
TSH %>% 
  count(CvQ)
```

## Condition

Column condition has had name change - change back

```{r}
TSH  <- 
  TSH %>% 
  rename(Condition = `Condition and restrictions on cohorts`)
```

```{r}
TSH %>% 
  count(Condition)
```

Lots of mis-spelling etc. Will use the methods of key collision and ngram fingerprints to correct. This is done by the `refinr` package

<https://cran.r-project.org/web/packages/refinr/vignettes/refinr-vignette.html>. 

These methods come from openrefine - see also

<https://github.com/OpenRefine/OpenRefine/wiki/Clustering-In-Depth>


```{r code=readLines("../code/clean_levels.R"), eval = FALSE}
```

```{r}
clean_levels(TSH$Condition, check = TRUE)
blacklist  <- c("Breast cancer BMI>25", 
                "Breast cancer BMI >25", 
                "fatty liver-men U/s+ ALT+", 
                "Fatty liver women U/s+ ALT+"
                )
clean_levels(TSH$Condition, check = TRUE, blacklist = blacklist)
```

So looks reasonable so change

Some not to be changed, 

```{r}
TSH  <- 
  TSH %>% mutate(
  Condition = clean_levels(Condition, blacklist = blacklist)
)
```

## Condition mapper

First we read in the mapper:

```{r}
condition_mapper  <- read_excel("../data/20190324_condition_mapper.xlsx")
condition_mapper %>% kable()
```

Function to convert condition to system

```{r, fig.asp=5}
cond_to_system  <- function(x, mapper){
  x  <- str_to_lower(x)
  mapper$condition  <- str_to_lower(mapper$condition)
  systems  <- unique(mapper$system)
  n_systems  <- length(systems)
  N  <- length(x)
  M  <- matrix(rep(0, n_systems * N), nc = n_systems, nr = N)
  colnames(M)  <- systems
  for(i in 1:n_systems){
    conditions  <- 
      mapper %>% filter(system == systems[i]) %>% 
      pull(condition)
    for(j in conditions){
      M[,i]  <- M[,i] + str_detect(x, j)
    }    
  }
  M  <- pmin(M, 1)
  get_system  <- function(row){
    if(sum(row) == 0){
      return("other")
    } else if(sum(row) == 1){
      return(names(row[row == 1]))
    } else {
      return("mixed")
    }
  }
  return(apply(M, 1, get_system))
}

TSH$system  <- cond_to_system(TSH$Condition, condition_mapper)
TSH %>% 
  filter(system == "other") %>% 
  pull(Condition)
```


I have changed BP, insulin, and diabetes to metabolic. 

## FT4_N

```{r}
table(TSH$FT4_N)
```

So some seem to have cases and controls. I will use the total as N, also not stated I will see to NA. Finally approx will be set to the value. 

```{r code=readLines("../code/clean_n.R"), eval = FALSE}
```

```{r}
clean_n(TSH$FT4_N, check = TRUE)
```

```{r}
TSH  <- 
  TSH %>%
  mutate(
  FT4_N = clean_n(FT4_N)
  )
```

```{r}
summary(TSH$FT4_N)
```


## FT4 method

```{r}
TSH %>% 
  count(FT4_method)
```

```{r}
clean_levels(TSH$FT4_method, check = TRUE)
```

```{r}
TSH  <- 
  TSH %>% 
  mutate(
    FT4_method = clean_levels(FT4_method)
  )
```


## FT4 sig

```{r}
TSH %>% count(FT4_Sig)
```

Not sure what N* is. NB has found that N* are inferred, but fine. Will convert and add inferred column

```{r code=readLines("../code/get_inferred.R"), eval = FALSE}
```

```{r}
TSH  <- 
  TSH %>% 
  mutate(FT4_inferred = get_inferred(FT4_Sig))
table(TSH$FT4_Sig, TSH$FT4_inferred)
TSH  <- 
  TSH %>% 
  mutate(FT4_Sig = str_replace_all(FT4_Sig, "\\*", ""))
table(TSH$FT4_Sig, TSH$FT4_inferred)
```


## FT4 PV

Function to take PV column and convert to PV, OR CI, and count CI. 

```{r code=readLines("../code/clean_pv.R"), eval = FALSE}
```

```{r}
clean_pv(TSH$FT4_PV, check = TRUE)
```

Nigel - you need to check and edit these. 

```{r}
pv  <- clean_pv(TSH$FT4_PV)
pv  <- pv %>% select(-origin_x)
pv
TSH  <- 
  TSH %>% 
  bind_cols(pv)
```

Have removed CI, and converted $< p $ to p. 

```{r}
TSH %>% 
  ggplot(aes(FT4_pv)) + geom_histogram(col = "black", fill = "orange")
```


## FT4_cov

```{r}
clean_levels(TSH$FT4_cov, check = TRUE)
```

```{r}
TSH  <- 
  TSH %>% 
  mutate(
    FT4_cov = clean_levels(FT4_cov)
  )
```

## FT4_sophistication

```{r}
TSH %>% count(FT4_Sophistication)
TSH %>% filter(is.na(FT4_Sophistication))
```

## TSH_N

```{r}
clean_n(TSH$TSH_N, check = TRUE)
TSH  <- TSH %>% 
  mutate(TSH_N = clean_n(TSH_N))
```

## TSH_method


```{r}
clean_levels(TSH$TSH_method, check = TRUE)
TSH  <- 
  TSH %>% 
  mutate(TSH_method = clean_levels(TSH_method))
```

## TSH_sig

```{r}
TSH %>% 
  count(TSH_Sig)
```

```{r}
TSH  <- 
  TSH %>% 
  mutate(TSH_inferred = get_inferred(TSH_Sig))
table(TSH$TSH_Sig, TSH$TSH_inferred)
TSH  <- 
  TSH %>% 
  mutate(TSH_Sig = str_replace_all(TSH_Sig, "\\*", ""))
table(TSH$TSH_Sig, TSH$TSH_inferred)
```


## TSH PV

```{r}
clean_pv(TSH$TSH_PV, check = TRUE)
```

**NB**: Please correct


```{r}
pv  <- clean_pv(TSH$TSH_PV)
pv  <- pv %>% select(-origin_x)
pv
TSH  <- 
  TSH %>% 
  bind_cols(pv)
```

```{r}
TSH %>% 
  ggplot(aes(TSH_pv)) + geom_histogram(col = "black", fill = "orange")
```

## TSH cov

```{r}
clean_levels(TSH$TSH_cov, check = TRUE)
TSH  <- 
  TSH %>% 
  mutate(
    TSH_cov = clean_levels(TSH_cov)
  )
```

## TSH_sophistication

```{r}
TSH %>% count(TSH_Sophistication)
TSH %>% filter(is.na(TSH_Sophistication))
```


## T3 N

```{r}
clean_n(TSH$T3_N, check = TRUE)
TSH  <- 
  TSH %>% 
  mutate(
    T3_N = clean_n(T3_N)
  )
```

## T3 method

```{r}
clean_levels(TSH$T3_method, check = TRUE)
TSH  <- 
  TSH %>% 
  mutate(
    T3_method = clean_levels(T3_method)
  )
```

## T3 sig

```{r}
TSH %>% 
  count(T3_Sig)
```

Convert not stated to NA

```{r}
TSH$T3_Sig[TSH$T3_Sig == "not stated"]  <- NA
```

```{r}
TSH %>% 
  count(T3_Sig)
```

```{r}
TSH  <- 
  TSH %>% 
  mutate(T3_inferred = get_inferred(T3_Sig))
table(TSH$T3_Sig, TSH$T3_inferred)
TSH  <- 
  TSH %>% 
  mutate(T3_Sig = str_replace_all(T3_Sig, "\\*", ""))
table(TSH$T3_Sig, TSH$T3_inferred)
```


## T3 PV

```{r}
clean_pv(TSH$T3_PV, check = TRUE)
```

```{r}
pv  <- clean_pv(TSH$T3_PV)
pv  <- pv %>% select(-origin_x)
pv
TSH  <- 
  TSH %>% 
  bind_cols(pv)
```

```{r}
TSH %>% 
  ggplot(aes(T3_pv)) + geom_histogram(col = "black", fill = "orange")
```

## T3 cov

```{r}
clean_levels(TSH$T3_cov, check = TRUE)
TSH  <- 
  TSH %>% 
  mutate(
    T3_cov = clean_levels(T3_cov)
  )
```

## T3_sophistication

```{r}
TSH %>% count(T3_Sophistication)
```

## Total T3

```{r}
TSH %>% count(`T3 - Free or Total`)
```

Rename

```{r}
TSH  <- 
  TSH %>% 
  rename(
    T3_total = `T3 - Free or Total`
  )
```


## Remove original PV columns

```{r}
TSH  <- 
  TSH %>% 
  select(-FT4_PV, -TSH_PV, -T3_PV)
```

## Add cohort column


```{r code=readLines("../code/add_cohort.R"), eval = FALSE}
```

```{r}
TSH  <- 
  TSH %>% group_by(Paper) %>% 
  mutate(cohort = add_cohort(FT4_N))
```

```{r, fig.asp=2}
TSH %>% ggplot(aes(cohort, FT4_N)) + geom_point() + 
  facet_wrap(~Paper, scales = "free", ncol = 3)
```

## Check hyper / hypo

```{r}
TSH %>% 
  count(`hyper/hypo`)
```

## Devil advocate sampling

The idea is that within each paper / cohort, we will randomly select one small model, and one large model. 

First we will get a randomly selected low model

```{r}
set.seed(2019)
TSH  <- 
  TSH %>% 
  group_by(Paper, cohort) %>% 
  mutate(low_selected = get_DA(FT4_Sophistication, type = "Low"))
```


Check that one per paper / cohort 

```{r}
TSH %>% 
  filter(low_selected == TRUE) %>% 
  count(Paper, cohort) %>% 
  ungroup() %>% 
  count(n)
```

Now add high model

```{r}
set.seed(2019)
TSH  <- 
  TSH %>% 
  group_by(Paper, cohort) %>% 
  mutate(high_selected = get_DA(FT4_Sophistication, type = "High"))
```

Check again

```{r}
TSH %>% 
  filter(high_selected == TRUE) %>% 
  count(Paper, cohort) %>% 
  ungroup() %>% 
  count(n)
```

# Save clean data

```{r}
write_rds(TSH, glue("../data/{get_label()}"))
```

